<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merkle Tree Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #output {
            margin-top: 20px;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border: 1px solid #ddd;
            overflow-x: auto;
        }
        #dropZone {
            border: 2px dashed #bbb;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            color: #bbb;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Merkle Tree Generator</h1>

    <button id="connectButton">Conectar a MetaMask</button>
    <p id="account"></p>

    <p>Arrastra y suelta un archivo CSV con una lista de direcciones de wallets aquí:</p>
    <div id="dropZone">Arrastra el archivo aquí</div>
    <div id="output"></div>

    <h2>Validar dirección de wallet</h2>
    <p>Introduce una dirección de wallet para validar si está en el árbol de Merkle:</p>
    <input type="text" id="walletInput">
    <button onclick="validateWallet()">Validar</button>
    <div id="validationResult"></div>

    <script>
        let merkleTree = [];
        let leaves = [];
        let account = "";

        document.getElementById('connectButton').addEventListener('click', connectMetaMask);

        async function connectMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                    account = accounts[0];
                    document.getElementById('account').innerText = `Conectado: ${account}`;
                } catch (error) {
                    console.error(error);
                }
            } else {
                alert('MetaMask no está instalado.');
            }
        }

        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '#f0f0f0';
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.style.backgroundColor = '#fff';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '#fff';
            const file = e.dataTransfer.files[0];
            handleFile(file);
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                leaves = text.split(/\r?\n/).filter(line => line.trim() !== '');
                if (leaves.length === 0) {
                    document.getElementById('output').innerText = 'El archivo CSV está vacío o no contiene direcciones válidas.';
                    return;
                }
                merkleTree = createMerkleTree(leaves);
                document.getElementById('output').innerHTML = `<h2>Árbol de Merkle:</h2><pre>${JSON.stringify(merkleTree, null, 2)}</pre>`;
            };
            reader.readAsText(file);
        }

        function createMerkleTree(leaves) {
            if (leaves.length === 0) return [];
            if (leaves.length === 1) return leaves;
            const newLevel = [];
            for (let i = 0; i < leaves.length; i += 2) {
                if (i + 1 < leaves.length) {
                    newLevel.push(hash(leaves[i] + leaves[i + 1]));
                } else {
                    newLevel.push(leaves[i]);
                }
            }
            return [newLevel, ...createMerkleTree(newLevel)];
        }

        function hash(data) {
            return CryptoJS.SHA256(data).toString(CryptoJS.enc.Hex);
        }

        function validateWallet() {
            const wallet = document.getElementById('walletInput').value.trim();
            const isValid = leaves.includes(wallet);
            document.getElementById('validationResult').innerText = isValid ? 'La dirección de wallet está en el árbol de Merkle.' : 'La dirección de wallet NO está en el árbol de Merkle.';
        }

        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';
        document.head.appendChild(script);
    </script>
</body>
</html>
